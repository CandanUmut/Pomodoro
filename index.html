<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ortak Pomodoro ¬∑ Focus Circle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --panel: #020617;
      --card: #0b1120;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.2);
      --success: #22c55e;
      --danger: #f97373;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --radius: 16px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #0b1120, #020617 55%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: stretch;
      min-height: 100vh;
      overflow-y: auto;
    }

    a { color: var(--accent); }

    .app {
      max-width: 960px;
      width: 100%;
      padding: 24px 16px 32px;
    }

    .card-shell {
      position: relative;
      background: radial-gradient(circle at top, #020617, #020617 40%), var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(75, 85, 99, 0.4);
      backdrop-filter: blur(24px);
      overflow: hidden;
    }

    .card-shell > * { position: relative; z-index: 1; }

    .card-shell::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: var(--radius);
      background:
        radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.08), transparent 35%),
        radial-gradient(circle at 80% 0%, rgba(34, 197, 94, 0.08), transparent 30%);
      pointer-events: none;
      opacity: 0.6;
      animation: panelGlow 14s ease-in-out infinite;
      z-index: 0;
    }

    h1 {
      margin-top: 0;
      font-size: 2rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    h1 span.icon { font-size: 2.2rem; }

    .subtitle {
      color: var(--text-soft);
      margin-bottom: 12px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 16px;
    }

    .col {
      flex: 1 1 260px;
    }

    .section-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      resize: vertical;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(to right, #22c55e, #38bdf8);
      color: #0f172a;
      box-shadow: 0 8px 25px rgba(56, 189, 248, 0.45);
      transition: transform 0.1s, box-shadow 0.1s;
    }

    button.secondary {
      background: transparent;
      border: 1px solid #4b5563;
      color: var(--text-soft);
      box-shadow: none;
    }

    button[disabled] {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(75, 85, 99, 0.7);
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.9);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.7);
    }

    .topic-pill {
      margin-top: 6px;
      font-size: 0.85rem;
      border-color: rgba(56, 189, 248, 0.5);
      background: rgba(56, 189, 248, 0.1);
      color: var(--text);
      max-width: 100%;
      word-break: break-word;
    }

    .info-line {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .timer-shell {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .timer-display {
      font-size: 2.4rem;
      font-weight: 800;
      letter-spacing: 0.12em;
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), #020617);
    }

    .timer-phase-label {
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .timer-display.critical {
      border-color: var(--danger);
      box-shadow: 0 0 16px rgba(248, 113, 113, 0.4);
    }

    .room-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .players {
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      padding: 10px 12px;
      max-height: 260px;
      overflow-y: auto;
      font-size: 0.9rem;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);
    }

    .player-row {
      display: grid;
      grid-template-columns: 1.4fr auto;
      gap: 6px;
      align-items: center;
      padding: 6px 6px;
      border-bottom: 1px dashed rgba(31, 41, 55, 0.7);
      border-radius: 10px;
    }

    .player-row.you {
      background: rgba(56, 189, 248, 0.08);
      border: 1px solid rgba(56, 189, 248, 0.25);
      box-shadow: 0 6px 20px rgba(56, 189, 248, 0.08);
    }

    .player-row:last-child { border-bottom: none; }

    .player-name {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
    }

    .player-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    .player-tag {
      font-size: 0.75rem;
      padding: 3px 7px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      color: #e5e7eb;
      margin-left: 4px;
      background: rgba(255,255,255,0.03);
      font-weight: 600;
    }

    .stats-card {
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      padding: 10px 12px;
      font-size: 0.85rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px;
      margin-top: 6px;
    }

    .stat-pill {
      border-radius: 12px;
      border: 1px solid rgba(75, 85, 99, 0.8);
      padding: 6px 8px;
      text-align: center;
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .stat-value {
      font-size: 0.95rem;
      font-weight: 700;
      margin-top: 2px;
    }

    .badge-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .badge-chip {
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.5);
      padding: 4px 9px;
      font-size: 0.75rem;
      background: rgba(56, 189, 248, 0.1);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .reflection-shell {
      margin-top: 16px;
      border-radius: 12px;
      border: 1px solid rgba(75, 85, 99, 0.7);
      background: rgba(15, 23, 42, 0.95);
      padding: 12px 14px;
      font-size: 0.9rem;
    }

    .reflection-grid {
      display: grid;
      grid-template-columns: minmax(0,1.3fr) minmax(0,1.1fr);
      gap: 12px;
    }

    @media (max-width: 800px) {
      .reflection-grid {
        grid-template-columns: 1fr;
      }
    }

    .reflection-list {
      max-height: 230px;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 0.85rem;
    }

    .reflection-item {
      border-radius: 10px;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(15,23,42,0.95);
      padding: 8px 9px;
      margin-bottom: 6px;
    }

    .reflection-meta {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.75rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .reflection-text {
      white-space: pre-wrap;
    }

    .error {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 6px;
    }

    .lang-switch {
      position: absolute;
      right: 12px;
      top: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(56, 189, 248, 0.15);
      box-shadow: 0 10px 40px rgba(0,0,0,0.35);
      z-index: 5;
      pointer-events: auto;
    }

    .lang-btn {
      font-size: 0.8rem;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.8);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      cursor: pointer;
      min-width: 54px;
    }

    .identity-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .avatar-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #334155;
      background: rgba(15, 23, 42, 0.7);
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }

    .avatar-chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(56, 189, 248, 0.25);
    }

    .avatar-circle {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .streak-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(56, 189, 248, 0.1);
      border: 1px solid rgba(56, 189, 248, 0.3);
      color: var(--text);
      font-size: 0.9rem;
      animation: streakPulse 6s ease-in-out infinite;
    }

    @keyframes streakPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.25); }
      50% { box-shadow: 0 0 0 8px rgba(56, 189, 248, 0.05); }
    }

    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(48px, 1fr));
      gap: 10px;
      margin: 12px 0;
    }

    .avatar-option, .color-option {
      border: 1px solid #334155;
      background: rgba(15, 23, 42, 0.7);
      border-radius: 10px;
      height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }

    .avatar-option:hover, .color-option:hover {
      transform: translateY(-1px);
      border-color: rgba(56, 189, 248, 0.6);
      box-shadow: 0 8px 18px rgba(56, 189, 248, 0.2);
    }

    .avatar-option.selected, .color-option.selected {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.7);
    }

    .lang-btn.active {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.4);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
      padding: 16px;
    }

    .modal-overlay.active { display: flex; }

    .modal-card {
      background: #0b1120;
      border-radius: 16px;
      border: 1px solid rgba(56, 189, 248, 0.3);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
      width: 100%;
      max-width: 420px;
      padding: 18px;
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin: 0 0 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-desc {
      color: var(--text-soft);
      font-size: 0.95rem;
      margin-bottom: 10px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    @keyframes panelGlow {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.9; }
    }

    @media (max-width: 768px) {
      .card-shell { padding: 16px; }
      .timer-display { font-size: 2rem; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card-shell">
      <div class="identity-bar">
        <div class="lang-switch">
          <button class="lang-btn active" data-lang="tr">üáπüá∑ TR</button>
          <button class="lang-btn" data-lang="en">üá¨üáß EN</button>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <div class="avatar-chip" id="avatar-chip">
            <div class="avatar-circle" id="avatar-circle">üìö</div>
            <div style="display:flex; flex-direction:column; line-height:1.2;">
              <span id="avatar-name-label" style="font-weight:700;">-</span>
              <span style="font-size:0.8rem; color:var(--text-soft);" id="avatar-edit-label"></span>
            </div>
          </div>
          <div class="streak-pill" id="streak-pill" title="Streak">
            <span>üî•</span>
            <span id="streak-current">0</span>
            <span id="streak-label">g√ºnl√ºk seri</span>
            <span style="color:var(--text-soft); font-size:0.8rem;" id="streak-best"></span>
          </div>
        </div>
      </div>

      <div class="modal-overlay" id="name-modal">
        <div class="modal-card">
          <div class="modal-title"><span>üëã</span><span id="name-modal-title">Ho≈ü geldin</span></div>
          <div class="modal-desc" id="name-modal-desc">L√ºtfen g√∂r√ºnen adƒ±nƒ± yaz.</div>
          <input id="name-modal-input" placeholder="Adƒ±n" />
          <div class="error" id="name-modal-error"></div>
          <div class="modal-actions">
            <button id="name-modal-save">
              <span id="name-modal-save-text">Kaydet</span>
            </button>
          </div>
        </div>
      </div>

      <div class="modal-overlay" id="avatar-modal">
        <div class="modal-card">
          <div class="modal-title"><span>üé®</span><span id="avatar-modal-title">Avatarƒ±nƒ± se√ß</span></div>
          <div class="modal-desc" id="avatar-modal-desc">Emoji ve rengi √∂zelle≈ütir.</div>
          <div class="section-title" style="margin-top:6px;" id="avatar-emoji-label">Emoji</div>
          <div class="avatar-grid" id="avatar-emoji-grid"></div>
          <div class="section-title" style="margin-top:6px;" id="avatar-color-label">Renk</div>
          <div class="avatar-grid" id="avatar-color-grid"></div>
          <div class="modal-actions">
            <button class="secondary" id="avatar-cancel-btn">Kapat</button>
            <button id="avatar-save-btn"><span id="avatar-save-text">Kaydet</span></button>
          </div>
        </div>
      </div>

    <h1>
      <span class="icon">üçÖ</span>
      <span id="title-text">Ortak Pomodoro</span>
    </h1>
    <div class="subtitle" id="subtitle-text">
      Aynƒ± odada toplan, Pomodoro ba≈ülat, konuya odaklan ve sonunda herkesin notlarƒ±nƒ± oku.
    </div>

    <!-- SETUP -->
    <div class="row" id="setup-section">
      <div class="col">
        <div class="section-title" id="create-section-title">Yeni Oda Olu≈ütur</div>
        <label id="label-creator-name">ƒ∞smin</label>
        <input id="creator-name" placeholder="Umut, Nova vs." />

        <label style="margin-top:8px;" id="label-topic">Konu (√∂r: Rust √∂ƒürenme, makale okuma)</label>
        <input id="topic-input" placeholder="Bug√ºnk√º odak konun" />

        <div class="row" style="margin-top:8px; gap:10px;">
          <div class="col">
            <label id="label-focus-min">Odak s√ºresi (dakika)</label>
            <select id="focus-minutes">
              <option value="25">25</option>
              <option value="30">30</option>
              <option value="45">45</option>
              <option value="50">50</option>
            </select>
          </div>
          <div class="col">
            <label id="label-break-min">Mola s√ºresi (dakika)</label>
            <select id="break-minutes">
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="0">0</option>
            </select>
          </div>
        </div>

        <button id="create-room-btn" style="margin-top:12px;">
          <span id="btn-create-text">Oda Olu≈ütur</span> <span>‚ûï</span>
        </button>
        <div id="create-error" class="error"></div>
      </div>

      <div class="col">
        <div class="section-title" id="join-section-title">Koda / Linke G√∂re Katƒ±l</div>
        <label id="label-join-name">ƒ∞smin</label>
        <input id="join-name" placeholder="ƒ∞smin" />

        <label style="margin-top:8px;" id="label-join-code">Oda Kodu</label>
        <input id="join-code" placeholder="√ñrn: ABCD12" />

        <button id="join-room-btn" style="margin-top:12px;" class="secondary">
          <span id="btn-join-text">Odaya Katƒ±l</span> <span>‚û°Ô∏è</span>
        </button>
        <div id="join-help-text" style="margin-top:8px;font-size:0.8rem;color:var(--text-soft);">
          Eƒüer linkle geldiysen kod otomatik dolabilir.
        </div>
        <div id="join-error" class="error"></div>
      </div>
    </div>

    <!-- ROOM -->
    <div id="room-section" style="display:none; margin-top:16px;">
      <div class="row">
        <div class="col">
          <div class="section-title" id="room-section-title">Oda</div>
          <div class="pill">
            <span class="pill-dot" id="status-dot"></span>
            <span id="room-status-text">Bekleniyor...</span>
          </div>
          <div class="pill topic-pill">
            <span>üìö</span>
            <span id="room-topic">-</span>
          </div>
          <div class="info-line">
            <span id="room-code-label">Oda kodu:</span>
            <strong id="room-code">-</strong>
          </div>
          <div class="info-line">
            <span id="room-link-label">Link:</span>
            <a id="room-link" href="#" target="_blank" rel="noreferrer"></a>
          </div>
          <div class="info-line">
            <span id="room-host-label">Host:</span>
            <strong id="room-host">-</strong>
          </div>

          <div class="timer-shell">
            <div class="timer-phase-label" id="timer-phase-label">Hazƒ±r.</div>
            <div class="timer-display" id="timer-display">25:00</div>
            <div class="room-actions" id="room-actions"></div>
          </div>
        </div>

        <div class="col">
          <div class="section-title" id="players-section-title">Katƒ±lƒ±mcƒ±lar</div>
          <div class="players" id="participants-list"></div>

          <div class="section-title" style="margin-top:12px;" id="stats-section-title">
            Senin Serin & Rozetlerin
          </div>
          <div class="stats-card">
            <div class="stats-grid">
              <div class="stat-pill">
                <div class="stat-label" id="stat-total-min-label">Toplam odak</div>
                <div class="stat-value" id="stat-total-min">0 dk</div>
              </div>
              <div class="stat-pill">
                <div class="stat-label" id="stat-sessions-label">Tamamlanan sprint</div>
                <div class="stat-value" id="stat-sessions">0</div>
              </div>
              <div class="stat-pill">
                <div class="stat-label" id="stat-streak-label">G√ºnl√ºk seri</div>
                <div class="stat-value" id="stat-streak">0 üî•</div>
              </div>
            </div>
            <div class="badge-list" id="badge-list"></div>
          </div>
        </div>
      </div>

      <div class="reflection-shell">
        <div class="section-title" id="reflection-section-title">Reflection ¬∑ Oturum Sonu Notlarƒ±</div>
        <div class="reflection-grid">
          <div>
            <p id="reflection-hint" style="margin-top:0;margin-bottom:6px;color:var(--text-soft);font-size:0.85rem;">
              Oturum bittiƒüinde kƒ±sa bir not yaz: ne ba≈üardƒ±n, neleri fark ettin, bir dahaki sefer neyi farklƒ± yaparsƒ±n?
            </p>
            <label id="label-reflection-text">Notun</label>
            <textarea id="reflection-text" rows="4" placeholder="Bug√ºnk√º pomodoro bana ≈üunlarƒ± √∂ƒüretti..."></textarea>

            <div class="row" style="margin-top:8px; gap:10px;">
              <div class="col">
                <label id="label-mood">Nasƒ±l hissediyorsun?</label>
                <select id="reflection-mood">
                  <option value="">Se√ß (opsiyonel)</option>
                  <option value="onfire">üî• A≈üƒ±rƒ± odaklƒ±</option>
                  <option value="good">üôÇ ƒ∞yi</option>
                  <option value="meh">üòê Orta</option>
                  <option value="tired">üò¥ Yorgun</option>
                </select>
              </div>
              <div class="col">
                <label id="label-energy">Enerji seviyesi (1‚Äì5)</label>
                <select id="reflection-energy">
                  <option value="">-</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                </select>
              </div>
            </div>

            <button id="save-reflection-btn" style="margin-top:10px;">
              <span id="btn-save-reflection-text">Notumu Kaydet</span> <span>üí¨</span>
            </button>
            <div id="reflection-error" class="error"></div>
          </div>

          <div>
            <div style="font-size:0.85rem;color:var(--text-soft);margin-bottom:4px;" id="reflection-list-title">
              Oda Reflection Akƒ±≈üƒ±
            </div>
            <div class="reflection-list" id="reflection-list"></div>
          </div>
        </div>
      </div>

      <div style="margin-top:10px; font-size:0.8rem; color:var(--text-soft);" id="bottom-hint">
        Not: Bu uygulama sadece birlikte odaklanma ve kendi geli≈üimini takip ama√ßlƒ±dƒ±r; herhangi bir sosyal hesap, reklam veya takip yok.
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // --- Supabase config (senin projen) ---
  const SUPABASE_URL = "https://tkggowekxmnlixwinszl.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRrZ2dvd2VreG1ubGl4d2luc3psIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MzI1NjcsImV4cCI6MjA4MDMwODU2N30.y1GSvarl9YyBqMaP8x6SXeD88EJ10gjee4rlr6oLyZg";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const LS_CLIENT_ID = "focus_client_id_v1";
  const LS_STATE = "focus_state_v1";
  const LS_DISPLAY_NAME = "pomostudy_display_name";
  const LS_PROFILE_ID = "pomostudy_profile_id";
  const PHASE_GRACE_MS = 2000;

  let profileId = "";
  let profileData = null;
  const avatarEmojis = ["üìö", "üöÄ", "üß†", "üåô", "üî•", "üí°", "üéß", "üåü", "üìù", "üåä"];
  const avatarColors = ["#38bdf8", "#a855f7", "#22c55e", "#f97316", "#0ea5e9", "#ef4444", "#f59e0b", "#10b981"];

  // --- i18n ---
  let currentLang = "tr";

  const textMap = {
    tr: {
      title: "Ortak Pomodoro",
      subtitle: "Aynƒ± odada toplan, Pomodoro ba≈ülat, konuya odaklan ve sonunda herkesin notlarƒ±nƒ± oku.",
      createSectionTitle: "Yeni Oda Olu≈ütur",
      joinSectionTitle: "Koda / Linke G√∂re Katƒ±l",
      labelCreatorName: "ƒ∞smin",
      labelTopic: "Konu (√∂r: Rust √∂ƒürenme, makale okuma)",
      labelFocusMin: "Odak s√ºresi (dakika)",
      labelBreakMin: "Mola s√ºresi (dakika)",
      labelJoinName: "ƒ∞smin",
      labelJoinCode: "Oda Kodu",
      btnCreate: "Oda Olu≈ütur",
      btnJoin: "Odaya Katƒ±l",
      joinHelp: "Eƒüer linkle geldiysen kod otomatik dolabilir.",
      roomSectionTitle: "Oda",
      roomCodeLabel: "Oda kodu:",
      roomLinkLabel: "Link:",
      roomHostLabel: "Host:",
      playersSectionTitle: "Katƒ±lƒ±mcƒ±lar",
      statsSectionTitle: "Senin Serin & Rozetlerin",
      statTotalMinLabel: "Toplam odak",
      statSessionsLabel: "Tamamlanan sprint",
      statStreakLabel: "G√ºnl√ºk seri",
      statusWaiting: "Oda beklemede. Herkes hazƒ±r olunca Pomodoro ba≈ülat.",
      statusFocus: "Odak zamanƒ±! Bildirimleri kapat, sadece bu konuya bak.",
      statusBreak: "Mola zamanƒ±. G√∂z√ºn√º ekrandan ayƒ±r, biraz hareket et.",
      statusReflect: "Reflection zamanƒ±. Ne ba≈üardƒ±ƒüƒ±nƒ± yaz.",
      statusFinished: "Oturum bitti. ƒ∞stersen yeni bir oda a√ß.",
      timerReady: "Hazƒ±r.",
      timerFocusLabel: "Odak s√ºresi",
      timerBreakLabel: "Mola s√ºresi",
      reflectionSectionTitle: "Reflection ¬∑ Oturum Sonu Notlarƒ±",
      reflectionHint: "Oturum bittiƒüinde kƒ±sa bir not yaz: ne ba≈üardƒ±n, neleri fark ettin, bir dahaki sefer neyi farklƒ± yaparsƒ±n?",
      labelReflectionText: "Notun",
      labelMood: "Nasƒ±l hissediyorsun?",
      labelEnergy: "Enerji seviyesi (1‚Äì5)",
      btnSaveReflection: "Notumu Kaydet",
      reflectionListTitle: "Oda Reflection Akƒ±≈üƒ±",
      errorNameRequired: "ƒ∞smini yazmalƒ±sƒ±n.",
      errorTopicRequired: "Konu bo≈ü olamaz.",
      errorCodeRequired: "Oda kodu bo≈ü olamaz.",
      errorRoomNotFound: "B√∂yle bir oda bulunamadƒ±.",
      youLabel: "Sen",
      hostTag: "Host",
      btnStartFocus: "Pomodoro Ba≈ülat",
      btnSkipToBreak: "Direkt Molaya Ge√ß",
      btnFinish: "Oturumu Bitir",
      btnBackToLobby: "Lobiye D√∂n",
      reflectionSaved: "Not kaydedildi.",
      reflectionRequired: "L√ºtfen en az birka√ß kelime yaz.",
      streakSuffix: "üî•",
      streakLabel: "G√ºnl√ºk seri",
      streakBestLabel: "En iyi",
      avatarTitle: "Avatarƒ±nƒ± se√ß",
      avatarSubtitle: "Emoji ve rengi √∂zelle≈ütir",
      avatarSaveButton: "Kaydet",
      avatarCancelButton: "Kapat",
      avatarHint: "Avatarƒ±nƒ± d√ºzenle",
      badgeFirstFocus: "ƒ∞lk pomodoronu tamamladƒ±n",
      badgeHour: "60+ dakika odak",
      badgeFiveSessions: "5+ sprint",
      badgeThreeDayStreak: "3 g√ºnl√ºk seri",
      badgeSevenDayStreak: "7 g√ºnl√ºk seri",
      badgeLabel: "Rozetler",
      nameModalTitle: "Ho≈ü geldin!",
      nameModalDesc: "Uygulamayƒ± ki≈üiselle≈ütirmek i√ßin g√∂r√ºnen adƒ±nƒ± gir.",
      nameModalPlaceholder: "Adƒ±n",
      nameModalSave: "Kaydet",
      nameModalError: "L√ºtfen adƒ±nƒ± yaz."
    },
    en: {
      title: "Shared Pomodoro",
      subtitle: "Create a room, set a topic, focus together and share reflections at the end.",
      createSectionTitle: "Create New Room",
      joinSectionTitle: "Join with Code / Link",
      labelCreatorName: "Your name",
      labelTopic: "Topic (e.g. Learn Rust, read paper)",
      labelFocusMin: "Focus time (minutes)",
      labelBreakMin: "Break time (minutes)",
      labelJoinName: "Your name",
      labelJoinCode: "Room Code",
      btnCreate: "Create Room",
      btnJoin: "Join Room",
      joinHelp: "If you came via shared link, the code might be auto-filled.",
      roomSectionTitle: "Room",
      roomCodeLabel: "Room code:",
      roomLinkLabel: "Link:",
      roomHostLabel: "Host:",
      playersSectionTitle: "Participants",
      statsSectionTitle: "Your Streak & Badges",
      statTotalMinLabel: "Total focus",
      statSessionsLabel: "Completed sprints",
      statStreakLabel: "Daily streak",
      statusWaiting: "Room is waiting. Start the Pomodoro when everyone is ready.",
      statusFocus: "Focus time! Mute distractions and work only on this topic.",
      statusBreak: "Break time. Look away from the screen and move a bit.",
      statusReflect: "Reflection time. Write what you did and learned.",
      statusFinished: "Session finished. You can create a new room if you like.",
      timerReady: "Ready.",
      timerFocusLabel: "Focus phase",
      timerBreakLabel: "Break phase",
      reflectionSectionTitle: "Reflection ¬∑ End of Session Notes",
      reflectionHint: "When the session ends, write a short note: what did you do, notice, and want to improve next time?",
      labelReflectionText: "Your note",
      labelMood: "How do you feel?",
      labelEnergy: "Energy level (1‚Äì5)",
      btnSaveReflection: "Save my note",
      reflectionListTitle: "Room Reflection Feed",
      errorNameRequired: "Please enter your name.",
      errorTopicRequired: "Topic cannot be empty.",
      errorCodeRequired: "Room code cannot be empty.",
      errorRoomNotFound: "Room not found.",
      youLabel: "You",
      hostTag: "Host",
      btnStartFocus: "Start Pomodoro",
      btnSkipToBreak: "Skip to Break",
      btnFinish: "End Session",
      btnBackToLobby: "Back to Lobby",
      reflectionSaved: "Note saved.",
      reflectionRequired: "Please write at least a few words.",
      streakSuffix: "üî•",
      streakLabel: "Daily streak",
      streakBestLabel: "Best",
      avatarTitle: "Choose avatar",
      avatarSubtitle: "Pick an emoji and color",
      avatarSaveButton: "Save",
      avatarCancelButton: "Close",
      avatarHint: "Edit avatar",
      badgeFirstFocus: "Completed your first Pomodoro",
      badgeHour: "60+ minutes focused",
      badgeFiveSessions: "5+ sprints",
      badgeThreeDayStreak: "3-day streak",
      badgeSevenDayStreak: "7-day streak",
      badgeLabel: "Badges",
      nameModalTitle: "Welcome!",
      nameModalDesc: "Enter the name we should show inside the app.",
      nameModalPlaceholder: "Your name",
      nameModalSave: "Save",
      nameModalError: "Please enter your name."
    }
  };

  function t(key) {
    return textMap[currentLang][key] || textMap["tr"][key] || key;
  }

  function applyDisplayNameToInputs(name) {
    if (!name) return;
    if (!creatorNameInput.value) creatorNameInput.value = name;
    if (!joinNameInput.value) joinNameInput.value = name;
  }

  let pendingNameResolve = null;

  function openNameModal() {
    nameModal.classList.add("active");
    nameModalError.textContent = "";
    nameModalInput.value = creatorNameInput.value || joinNameInput.value || "";
    setTimeout(() => nameModalInput.focus(), 50);
  }

  function closeNameModal() {
    nameModal.classList.remove("active");
  }

  function handleNameSave() {
    const value = nameModalInput.value.trim();
    if (!value) {
      nameModalError.textContent = t("nameModalError");
      return;
    }
    nameModalError.textContent = "";
    localStorage.setItem(LS_DISPLAY_NAME, value);
    localStorage.removeItem(LS_PROFILE_ID);
    profileId = "";
    applyDisplayNameToInputs(value);
    closeNameModal();
    if (pendingNameResolve) {
      pendingNameResolve(value);
      pendingNameResolve = null;
    }
  }

  nameModalSave.addEventListener("click", handleNameSave);
  nameModalInput.addEventListener("keydown", ev => {
    if (ev.key === "Enter") {
      handleNameSave();
    }
  });

  async function ensureDisplayName() {
    const stored = localStorage.getItem(LS_DISPLAY_NAME);
    if (stored) {
      applyDisplayNameToInputs(stored);
      return stored;
    }
    openNameModal();
    return new Promise(resolve => {
      pendingNameResolve = resolve;
    });
  }

  // --- Dom refs ---
  const setupSection = document.getElementById("setup-section");
  const roomSection = document.getElementById("room-section");

  const titleText = document.getElementById("title-text");
  const subtitleText = document.getElementById("subtitle-text");
  const createSectionTitle = document.getElementById("create-section-title");
  const joinSectionTitle = document.getElementById("join-section-title");
  const labelCreatorName = document.getElementById("label-creator-name");
  const labelTopic = document.getElementById("label-topic");
  const labelFocusMin = document.getElementById("label-focus-min");
  const labelBreakMin = document.getElementById("label-break-min");
  const labelJoinName = document.getElementById("label-join-name");
  const labelJoinCode = document.getElementById("label-join-code");
  const btnCreateText = document.getElementById("btn-create-text");
  const btnJoinText = document.getElementById("btn-join-text");
  const joinHelpText = document.getElementById("join-help-text");

  const nameModal = document.getElementById("name-modal");
  const nameModalTitle = document.getElementById("name-modal-title");
  const nameModalDesc = document.getElementById("name-modal-desc");
  const nameModalInput = document.getElementById("name-modal-input");
  const nameModalSave = document.getElementById("name-modal-save");
  const nameModalSaveText = document.getElementById("name-modal-save-text");
  const nameModalError = document.getElementById("name-modal-error");

  const roomSectionTitle = document.getElementById("room-section-title");
  const roomStatusText = document.getElementById("room-status-text");
  const statusDot = document.getElementById("status-dot");
  const roomTopicEl = document.getElementById("room-topic");
  const roomCodeLabel = document.getElementById("room-code-label");
  const roomCodeEl = document.getElementById("room-code");
  const roomLinkLabel = document.getElementById("room-link-label");
  const roomLinkEl = document.getElementById("room-link");
  const roomHostLabel = document.getElementById("room-host-label");
  const roomHostEl = document.getElementById("room-host");
  const timerDisplay = document.getElementById("timer-display");
  const timerPhaseLabel = document.getElementById("timer-phase-label");
  const roomActions = document.getElementById("room-actions");
  const participantsList = document.getElementById("participants-list");

  const statsSectionTitle = document.getElementById("stats-section-title");
  const statTotalMinLabel = document.getElementById("stat-total-min-label");
  const statSessionsLabel = document.getElementById("stat-sessions-label");
  const statStreakLabel = document.getElementById("stat-streak-label");
  const statTotalMinValue = document.getElementById("stat-total-min");
  const statSessionsValue = document.getElementById("stat-sessions");
  const statStreakValue = document.getElementById("stat-streak");
  const badgeListEl = document.getElementById("badge-list");

  const reflectionSectionTitle = document.getElementById("reflection-section-title");
  const reflectionHint = document.getElementById("reflection-hint");
  const labelReflectionText = document.getElementById("label-reflection-text");
  const labelMood = document.getElementById("label-mood");
  const labelEnergy = document.getElementById("label-energy");
  const btnSaveReflectionText = document.getElementById("btn-save-reflection-text");
  const reflectionListTitle = document.getElementById("reflection-list-title");

  const reflectionTextEl = document.getElementById("reflection-text");
  const reflectionMoodEl = document.getElementById("reflection-mood");
  const reflectionEnergyEl = document.getElementById("reflection-energy");
  const reflectionListEl = document.getElementById("reflection-list");
  const reflectionErrorEl = document.getElementById("reflection-error");

  const createErrorEl = document.getElementById("create-error");
  const joinErrorEl = document.getElementById("join-error");

  const avatarChip = document.getElementById("avatar-chip");
  const avatarCircle = document.getElementById("avatar-circle");
  const avatarNameLabel = document.getElementById("avatar-name-label");
  const avatarEditLabel = document.getElementById("avatar-edit-label");
  const avatarModal = document.getElementById("avatar-modal");
  const avatarEmojiGrid = document.getElementById("avatar-emoji-grid");
  const avatarColorGrid = document.getElementById("avatar-color-grid");
  const avatarSaveBtn = document.getElementById("avatar-save-btn");
  const avatarCancelBtn = document.getElementById("avatar-cancel-btn");
  const avatarModalTitle = document.getElementById("avatar-modal-title");
  const avatarModalDesc = document.getElementById("avatar-modal-desc");
  const avatarEmojiLabel = document.getElementById("avatar-emoji-label");
  const avatarColorLabel = document.getElementById("avatar-color-label");
  const avatarSaveText = document.getElementById("avatar-save-text");

  const streakPill = document.getElementById("streak-pill");
  const streakCurrent = document.getElementById("streak-current");
  const streakLabel = document.getElementById("streak-label");
  const streakBest = document.getElementById("streak-best");

  // Inputs
  const creatorNameInput = document.getElementById("creator-name");
  const topicInput = document.getElementById("topic-input");
  const focusMinutesSelect = document.getElementById("focus-minutes");
  const breakMinutesSelect = document.getElementById("break-minutes");
  const joinNameInput = document.getElementById("join-name");
  const joinCodeInput = document.getElementById("join-code");

  // Buttons
  const createRoomBtn = document.getElementById("create-room-btn");
  const joinRoomBtn = document.getElementById("join-room-btn");
  const saveReflectionBtn = document.getElementById("save-reflection-btn");

  // State
  let clientId = null;
  let currentRoom = null;
  let currentParticipant = null;
  let participants = [];
  let myStats = null;
  let isHost = false;
  let timerInterval = null;

  // --- Utils ---
  function ensureClientId() {
    let id = localStorage.getItem(LS_CLIENT_ID);
    if (!id) {
      if (crypto && crypto.randomUUID) {
        id = crypto.randomUUID();
      } else {
        id = "c_" + Math.random().toString(36).slice(2);
      }
      localStorage.setItem(LS_CLIENT_ID, id);
    }
    clientId = id;
  }

  function randomSlug(len = 6) {
    return Math.random().toString(36).substring(2, 2 + len).toUpperCase();
  }

  function formatTimeLeft(seconds) {
    const s = Math.max(0, seconds);
    const m = Math.floor(s / 60);
    const r = s % 60;
    const mm = m.toString().padStart(2, "0");
    const ss = r.toString().padStart(2, "0");
    return `${mm}:${ss}`;
  }

  function phaseDurationSeconds(room) {
    if (!room) return 0;
    if (room.status === "focus") return (room.focus_minutes || 25) * 60;
    if (room.status === "break") return (room.break_minutes || 0) * 60;
    return 0;
  }

  function moodEmoji(mood) {
    if (mood === "onfire") return "üî•";
    if (mood === "good") return "üôÇ";
    if (mood === "meh") return "üòê";
    if (mood === "tired") return "üò¥";
    return "üí¨";
  }

  function saveLocalState() {
    if (!currentRoom || !currentParticipant || !clientId) return;
    const payload = {
      roomSlug: currentRoom.slug,
      participantId: currentParticipant.id,
      clientId
    };
    localStorage.setItem(LS_STATE, JSON.stringify(payload));
  }

  function clearLocalState() {
    localStorage.removeItem(LS_STATE);
  }

  // --- i18n apply ---
  function applyLanguage() {
    titleText.textContent = t("title");
    subtitleText.textContent = t("subtitle");
    createSectionTitle.textContent = t("createSectionTitle");
    joinSectionTitle.textContent = t("joinSectionTitle");
    labelCreatorName.textContent = t("labelCreatorName");
    labelTopic.textContent = t("labelTopic");
    labelFocusMin.textContent = t("labelFocusMin");
    labelBreakMin.textContent = t("labelBreakMin");
    labelJoinName.textContent = t("labelJoinName");
    labelJoinCode.textContent = t("labelJoinCode");
    btnCreateText.textContent = t("btnCreate");
    btnJoinText.textContent = t("btnJoin");
    joinHelpText.textContent = t("joinHelp");

    roomSectionTitle.textContent = t("roomSectionTitle");
    roomCodeLabel.textContent = t("roomCodeLabel");
    roomLinkLabel.textContent = t("roomLinkLabel");
    roomHostLabel.textContent = t("roomHostLabel");
    statsSectionTitle.textContent = t("statsSectionTitle");
    statTotalMinLabel.textContent = t("statTotalMinLabel");
    statSessionsLabel.textContent = t("statSessionsLabel");
    statStreakLabel.textContent = t("statStreakLabel");

    reflectionSectionTitle.textContent = t("reflectionSectionTitle");
    reflectionHint.textContent = t("reflectionHint");
    labelReflectionText.textContent = t("labelReflectionText");
    labelMood.textContent = t("labelMood");
    labelEnergy.textContent = t("labelEnergy");
    btnSaveReflectionText.textContent = t("btnSaveReflection");
    reflectionListTitle.textContent = t("reflectionListTitle");
    nameModalTitle.textContent = t("nameModalTitle");
    nameModalDesc.textContent = t("nameModalDesc");
    nameModalInput.placeholder = t("nameModalPlaceholder");
    nameModalSaveText.textContent = t("nameModalSave");

    avatarModalTitle.textContent = t("avatarTitle");
    avatarModalDesc.textContent = t("avatarSubtitle");
    avatarEmojiLabel.textContent = t("avatarTitle");
    avatarColorLabel.textContent = t("avatarSubtitle");
    avatarSaveText.textContent = t("avatarSaveButton");
    avatarCancelBtn.textContent = t("avatarCancelButton");
    avatarEditLabel.textContent = t("avatarHint");
    streakLabel.textContent = t("streakLabel");
    streakBest.textContent = `${t("streakBestLabel")}: 0`;

    updateRoomUI();
    renderStats();
    renderAvatar();
  }

  function getDisplayName() {
    return localStorage.getItem(LS_DISPLAY_NAME) || "";
  }

  async function ensureProfileRow(name) {
    if (!name) return null;
    const storedProfile = localStorage.getItem(LS_PROFILE_ID);
    if (storedProfile) {
      profileId = storedProfile;
      return storedProfile;
    }
    try {
      const { data: existing, error } = await supabase
        .from("study_profiles")
        .select("id, avatar_emoji, avatar_color, streak_days, best_streak")
        .eq("display_name", name)
        .maybeSingle();
      if (error) {
        console.warn("profile fetch error", error.message);
      }
      if (existing && existing.id) {
        profileId = existing.id;
        localStorage.setItem(LS_PROFILE_ID, existing.id);
        profileData = existing;
        return existing.id;
      }
    } catch (err) {
      console.warn("profile fetch exception", err);
    }
    try {
      const { data: inserted, error: insertError } = await supabase
        .from("study_profiles")
        .insert({ display_name: name })
        .select("id, avatar_emoji, avatar_color, streak_days, best_streak")
        .single();
      if (insertError) {
        console.warn("profile insert error", insertError.message);
        return null;
      }
      if (inserted && inserted.id) {
        profileId = inserted.id;
        localStorage.setItem(LS_PROFILE_ID, inserted.id);
        profileData = inserted;
        return inserted.id;
      }
    } catch (err) {
      console.warn("profile insert exception", err);
    }
    return null;
  }

  async function loadProfileData() {
    if (!profileId) return;
    const { data, error } = await supabase
      .from("study_profiles")
      .select("id, avatar_emoji, avatar_color, streak_days, best_streak")
      .eq("id", profileId)
      .maybeSingle();
    if (!error && data) {
      profileData = data;
    }
    renderAvatar();
  }

  function renderAvatar() {
    const name = getDisplayName();
    avatarNameLabel.textContent = name || "-";
    const emoji = (profileData && profileData.avatar_emoji) || "üìö";
    const color = (profileData && profileData.avatar_color) || "#38bdf8";
    avatarCircle.textContent = emoji;
    avatarCircle.style.background = color;
    streakCurrent.textContent = profileData?.streak_days ?? 0;
    streakBest.textContent = `${t("streakBestLabel")}: ${profileData?.best_streak ?? 0}`;
  }

  function openAvatarModal() {
    avatarModal.classList.add("active");
    avatarEmojiGrid.innerHTML = "";
    avatarColorGrid.innerHTML = "";
    const currentEmoji = (profileData && profileData.avatar_emoji) || "üìö";
    const currentColor = (profileData && profileData.avatar_color) || "#38bdf8";
    avatarEmojis.forEach(emo => {
      const btn = document.createElement("div");
      btn.className = "avatar-option" + (emo === currentEmoji ? " selected" : "");
      btn.textContent = emo;
      btn.onclick = () => {
        avatarEmojiGrid.querySelectorAll(".avatar-option").forEach(el => el.classList.remove("selected"));
        btn.classList.add("selected");
      };
      avatarEmojiGrid.appendChild(btn);
    });
    avatarColors.forEach(color => {
      const btn = document.createElement("div");
      btn.className = "color-option" + (color === currentColor ? " selected" : "");
      btn.style.background = color;
      btn.onclick = () => {
        avatarColorGrid.querySelectorAll(".color-option").forEach(el => el.classList.remove("selected"));
        btn.classList.add("selected");
      };
      avatarColorGrid.appendChild(btn);
    });
  }

  function closeAvatarModal() {
    avatarModal.classList.remove("active");
  }

  async function saveAvatarSelection() {
    const selectedEmoji = avatarEmojiGrid.querySelector(".avatar-option.selected")?.textContent || "üìö";
    const selectedColor = avatarColorGrid.querySelector(".color-option.selected")?.style.background || "#38bdf8";
    const name = getDisplayName();
    if (!profileId) {
      await ensureProfileRow(name);
    }
    if (!profileId) {
      closeAvatarModal();
      return;
    }
    const { data, error } = await supabase
      .from("study_profiles")
      .update({ avatar_emoji: selectedEmoji, avatar_color: selectedColor })
      .eq("id", profileId)
      .select("id, avatar_emoji, avatar_color, streak_days, best_streak")
      .maybeSingle();
    if (!error && data) {
      profileData = data;
      renderAvatar();
    }
    closeAvatarModal();
  }

  // --- Supabase helpers ---
  async function fetchRoomBySlug(slug) {
    const { data, error } = await supabase
      .from("focus_rooms")
      .select("*")
      .eq("slug", slug)
      .single();
    if (error) return null;
    return data;
  }

  async function fetchRoomById(id) {
    const { data, error } = await supabase
      .from("focus_rooms")
      .select("*")
      .eq("id", id)
      .single();
    if (error) return null;
    return data;
  }

  async function fetchParticipantById(id) {
    const { data, error } = await supabase
      .from("focus_participants")
      .select("*")
      .eq("id", id)
      .single();
    if (error) return null;
    return data;
  }

  async function fetchParticipants(roomId) {
    const { data, error } = await supabase
      .from("focus_participants")
      .select("*")
      .eq("room_id", roomId)
      .order("created_at", { ascending: true });
    if (!error && data) {
      participants = data;
      const me = participants.find(p => p.id === (currentParticipant && currentParticipant.id));
      if (me) currentParticipant = me;
      updateRoomUI();
    }
  }

  async function fetchMyStats() {
    if (!clientId) return;
    const { data, error } = await supabase
      .from("focus_users")
      .select("*")
      .eq("client_id", clientId)
      .maybeSingle();
    if (!error && data) {
      myStats = data;
      renderStats();
    }
  }

  async function ensureMyStats(displayName) {
    if (!clientId) return;
    const payload = {
      client_id: clientId,
      display_name: displayName || (myStats && myStats.display_name) || null
    };
    const { data, error } = await supabase
      .from("focus_users")
      .upsert(payload, { onConflict: "client_id" })
      .select()
      .single();
    if (!error && data) {
      myStats = data;
      renderStats();
    }
  }

  // --- Badges ---
  function computeBadges(stats) {
    if (!stats) return [];
    const badges = [];
    if (stats.total_sessions >= 1) {
      badges.push({ id: "first", label: t("badgeFirstFocus"), emoji: "ü•â" });
    }
    if (stats.total_focus_minutes >= 60) {
      badges.push({ id: "hour", label: t("badgeHour"), emoji: "‚è±" });
    }
    if (stats.total_sessions >= 5) {
      badges.push({ id: "five", label: t("badgeFiveSessions"), emoji: "üöÄ" });
    }
    if (stats.streak_days >= 3) {
      badges.push({ id: "three-streak", label: t("badgeThreeDayStreak"), emoji: "üî•" });
    }
    if (stats.longest_streak_days >= 7) {
      badges.push({ id: "seven-streak", label: t("badgeSevenDayStreak"), emoji: "üèÜ" });
    }
    return badges;
  }

  function renderStats() {
    if (!myStats) {
      statTotalMinValue.textContent = "0 dk";
      statSessionsValue.textContent = "0";
      statStreakValue.textContent = "0 " + t("streakSuffix");
      badgeListEl.innerHTML = "";
      return;
    }

    statTotalMinValue.textContent = `${myStats.total_focus_minutes} dk`;
    statSessionsValue.textContent = `${myStats.total_sessions}`;
    statStreakValue.textContent = `${myStats.streak_days} ${t("streakSuffix")}`;

    const badges = computeBadges(myStats);
    badgeListEl.innerHTML = "";
    badges.forEach(b => {
      const chip = document.createElement("div");
      chip.className = "badge-chip";
      chip.innerHTML = `<span>${b.emoji}</span><span>${b.label}</span>`;
      badgeListEl.appendChild(chip);
    });
  }

  // --- Room UI ---
  function updateRoomUI() {
    if (!currentRoom) return;

    roomTopicEl.textContent = currentRoom.topic || "-";
    roomCodeEl.textContent = currentRoom.slug;
    const link = `${window.location.origin}${window.location.pathname}?room=${currentRoom.slug}`;
    roomLinkEl.href = link;
    roomLinkEl.textContent = link;
    roomHostEl.textContent = currentRoom.host_name || "-";

    let statusText = "";
    if (currentRoom.status === "waiting") statusText = t("statusWaiting");
    else if (currentRoom.status === "focus") statusText = t("statusFocus");
    else if (currentRoom.status === "break") statusText = t("statusBreak");
    else if (currentRoom.status === "reflect") statusText = t("statusReflect");
    else statusText = t("statusFinished");

    roomStatusText.textContent = statusText;

    // status dot color
    if (currentRoom.status === "focus") {
      statusDot.style.background = "#22c55e";
    } else if (currentRoom.status === "break") {
      statusDot.style.background = "#fbbf24";
    } else if (currentRoom.status === "reflect") {
      statusDot.style.background = "#38bdf8";
    } else {
      statusDot.style.background = "#9ca3af";
    }

    // participants
    participantsList.innerHTML = "";
    participants.forEach(p => {
      const row = document.createElement("div");
      row.className = "player-row";
      if (currentParticipant && p.id === currentParticipant.id) {
        row.classList.add("you");
      }

      const left = document.createElement("div");
      left.className = "player-name";
      const dot = document.createElement("div");
      dot.className = "player-dot";
      left.appendChild(dot);

      const nameSpan = document.createElement("span");
      nameSpan.textContent = p.name;
      left.appendChild(nameSpan);

      if (currentParticipant && p.id === currentParticipant.id) {
        const tag = document.createElement("span");
        tag.className = "player-tag";
        tag.textContent = t("youLabel");
        tag.style.borderColor = "rgba(56,189,248,0.7)";
        left.appendChild(tag);
      }

      const right = document.createElement("div");
      right.style.textAlign = "right";

      if (p.is_host) {
        const hostTag = document.createElement("span");
        hostTag.className = "player-tag";
        hostTag.textContent = t("hostTag");
        right.appendChild(hostTag);
      }

      row.appendChild(left);
      row.appendChild(right);
      participantsList.appendChild(row);
    });

    // actions (only host kontrol but everyone zaman g√∂rs√ºn)
    roomActions.innerHTML = "";
    if (isHost) {
      if (currentRoom.status === "waiting") {
        const btnStart = document.createElement("button");
        btnStart.textContent = t("btnStartFocus");
        btnStart.onclick = startFocusPhase;
        roomActions.appendChild(btnStart);
      } else if (currentRoom.status === "focus") {
        const btnSkip = document.createElement("button");
        btnSkip.className = "secondary";
        btnSkip.textContent = t("btnSkipToBreak");
        btnSkip.onclick = async () => advancePhase("break");
        roomActions.appendChild(btnSkip);
      } else if (currentRoom.status === "break") {
        const btnNext = document.createElement("button");
        btnNext.textContent = t("statusReflect");
        btnNext.onclick = () => advancePhase("reflect");
        roomActions.appendChild(btnNext);
      }

      if (currentRoom.status !== "finished") {
        const btnFinish = document.createElement("button");
        btnFinish.className = "secondary";
        btnFinish.textContent = t("btnFinish");
        btnFinish.onclick = endSession;
        roomActions.appendChild(btnFinish);
      }
    }

    const btnBack = document.createElement("button");
    btnBack.className = "secondary";
    btnBack.textContent = t("btnBackToLobby");
    btnBack.onclick = () => {
      clearLocalState();
      window.location.href = window.location.pathname;
    };
    roomActions.appendChild(btnBack);
  }

  function updateTimerUI() {
    if (!currentRoom) {
      timerPhaseLabel.textContent = t("timerReady");
      timerDisplay.textContent = "00:00";
      timerDisplay.classList.remove("critical");
      return;
    }

    const now = Date.now();
    let secondsLeft = 0;
    if (currentRoom.phase_ends_at && (currentRoom.status === "focus" || currentRoom.status === "break")) {
      const endMs = new Date(currentRoom.phase_ends_at).getTime();
      secondsLeft = Math.max(0, Math.round((endMs - now) / 1000));
    } else if (currentRoom.status === "focus") {
      secondsLeft = (currentRoom.focus_minutes || 25) * 60;
    } else if (currentRoom.status === "break") {
      secondsLeft = (currentRoom.break_minutes || 0) * 60;
    } else {
      secondsLeft = (currentRoom.focus_minutes || 25) * 60;
    }

    if (currentRoom.status === "focus") {
      timerPhaseLabel.textContent = t("timerFocusLabel");
    } else if (currentRoom.status === "break") {
      timerPhaseLabel.textContent = t("timerBreakLabel");
    } else if (currentRoom.status === "reflect") {
      timerPhaseLabel.textContent = t("statusReflect");
    } else if (currentRoom.status === "finished") {
      timerPhaseLabel.textContent = t("statusFinished");
    } else {
      timerPhaseLabel.textContent = t("timerReady");
    }

    timerDisplay.textContent = formatTimeLeft(secondsLeft);
    if (currentRoom.status === "focus" || currentRoom.status === "break") {
      timerDisplay.classList.toggle("critical", secondsLeft <= 10);
    } else {
      timerDisplay.classList.remove("critical");
    }

    // host i√ßin otomatik faz ge√ßi≈üi
    if (isHost && (currentRoom.status === "focus" || currentRoom.status === "break") &&
        currentRoom.phase_ends_at) {
      const endMs = new Date(currentRoom.phase_ends_at).getTime();
      if (now > endMs + PHASE_GRACE_MS) {
        // focus bitti -> break / break bitti -> reflect
        const next =
          currentRoom.status === "focus"
            ? ((currentRoom.break_minutes || 0) > 0 ? "break" : "reflect")
            : "reflect";
        advancePhase(next);
      }
    }
  }

  // --- Phase transitions (host) ---
  async function startFocusPhase() {
    if (!currentRoom || !isHost) return;
    const now = new Date();
    const focusSeconds = (currentRoom.focus_minutes || 25) * 60;
    const end = new Date(now.getTime() + focusSeconds * 1000);

    const { data, error } = await supabase
      .from("focus_rooms")
      .update({
        status: "focus",
        phase_started_at: now.toISOString(),
        phase_ends_at: end.toISOString(),
        focus_awarded: false
      })
      .eq("id", currentRoom.id)
      .select()
      .single();

    if (!error && data) {
      currentRoom = data;
      updateRoomUI();
      updateTimerUI();
    }
  }

  async function awardFocusIfNeeded() {
    if (!currentRoom || !isHost) return;
    if (currentRoom.focus_awarded) return;

    const { data: roomParticipants } = await supabase
      .from("focus_participants")
      .select("*")
      .eq("room_id", currentRoom.id);

    if (!roomParticipants || !roomParticipants.length) return;

    const uniqueClientIds = [...new Set(roomParticipants.map(p => p.client_id))];

    const { data: existingStats } = await supabase
      .from("focus_users")
      .select("*")
      .in("client_id", uniqueClientIds);

    const statsMap = new Map();
    if (existingStats) {
      existingStats.forEach(s => statsMap.set(s.client_id, s));
    }

    const focusMinutes = currentRoom.focus_minutes || 25;
    const today = new Date().toISOString().slice(0, 10);

    const upserts = uniqueClientIds.map(id => {
      const prev = statsMap.get(id) || {
        client_id: id,
        display_name: null,
        total_focus_minutes: 0,
        total_sessions: 0,
        streak_days: 0,
        longest_streak_days: 0,
        last_focus_date: null
      };

      let streak = prev.streak_days || 0;
      let longest = prev.longest_streak_days || 0;
      const lastDate = prev.last_focus_date;

      if (!lastDate) {
        streak = 1;
      } else {
        const last = new Date(lastDate);
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const lastStr = last.toISOString().slice(0, 10);
        const todayStr = today;
        const yStr = yesterday.toISOString().slice(0, 10);

        if (lastStr === todayStr) {
          // aynƒ± g√ºn; streak deƒüi≈ümeden
        } else if (lastStr === yStr) {
          streak += 1;
        } else {
          streak = 1;
        }
      }

      if (streak > (longest || 0)) longest = streak;

      return {
        client_id: id,
        display_name: prev.display_name,
        total_focus_minutes: (prev.total_focus_minutes || 0) + focusMinutes,
        total_sessions: (prev.total_sessions || 0) + 1,
        streak_days: streak,
        longest_streak_days: longest,
        last_focus_date: today
      };
    });

    await supabase.from("focus_users").upsert(upserts, { onConflict: "client_id" });
    await supabase
      .from("focus_rooms")
      .update({ focus_awarded: true })
      .eq("id", currentRoom.id);

    // kendi stats‚Äôimizi yeniden √ßekelim
    await fetchMyStats();
  }

  async function advancePhase(nextStatus) {
    if (!currentRoom || !isHost) return;

    // focus -> break/reflect ge√ßerken bir kere istatistik i≈üleyelim
    if (currentRoom.status === "focus") {
      await awardFocusIfNeeded();
    }

    const now = new Date();
    let phaseStartedAt = now.toISOString();
    let phaseEndsAt = null;

    if (nextStatus === "focus") {
      const s = (currentRoom.focus_minutes || 25) * 60;
      phaseEndsAt = new Date(now.getTime() + s * 1000).toISOString();
    } else if (nextStatus === "break") {
      const s = (currentRoom.break_minutes || 0) * 60;
      phaseEndsAt = s > 0 ? new Date(now.getTime() + s * 1000).toISOString() : null;
    } else {
      phaseStartedAt = now.toISOString();
      phaseEndsAt = null;
    }

    const { data, error } = await supabase
      .from("focus_rooms")
      .update({
        status: nextStatus,
        phase_started_at: phaseStartedAt,
        phase_ends_at: phaseEndsAt
      })
      .eq("id", currentRoom.id)
      .select()
      .single();

    if (!error && data) {
      currentRoom = data;
      updateRoomUI();
      updateTimerUI();
    }
  }

  async function endSession() {
    if (!currentRoom || !isHost) return;

    if (currentRoom.status === "focus") {
      await awardFocusIfNeeded();
    }

    const { data, error } = await supabase
      .from("focus_rooms")
      .update({
        status: "finished",
        phase_started_at: null,
        phase_ends_at: null
      })
      .eq("id", currentRoom.id)
      .select()
      .single();

    if (!error && data) {
      currentRoom = data;
      updateRoomUI();
      updateTimerUI();
    }
  }

  // --- Reflection ---
  async function loadReflections() {
    if (!currentRoom) return;
    const { data, error } = await supabase
      .from("focus_reflections")
      .select("*")
      .eq("room_id", currentRoom.id)
      .order("created_at", { ascending: false });
    if (!error && data) {
      renderReflections(data);
    }
  }

  function renderReflections(rows) {
    reflectionListEl.innerHTML = "";
    if (!rows || !rows.length) {
      const empty = document.createElement("div");
      empty.style.color = "var(--text-soft)";
      empty.style.fontSize = "0.8rem";
      empty.textContent =
        currentLang === "tr"
          ? "Hen√ºz kimse not bƒ±rakmadƒ±."
          : "No reflections yet.";
      reflectionListEl.appendChild(empty);
      return;
    }

    const participantMap = new Map();
    participants.forEach(p => participantMap.set(p.id, p));

    rows.forEach(r => {
      const item = document.createElement("div");
      item.className = "reflection-item";

      const meta = document.createElement("div");
      meta.className = "reflection-meta";

      const left = document.createElement("span");
      const p = participantMap.get(r.participant_id);
      const name = p ? p.name : "Anon";
      left.textContent = name;

      const right = document.createElement("span");
      const mood = r.mood ? `${moodEmoji(r.mood)} ` : "";
      const energy = r.energy_level ? ` ¬∑ ‚ö°${r.energy_level}/5` : "";
      const date = new Date(r.created_at);
      const timeStr = date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      right.textContent = `${mood}${timeStr}${energy}`;

      meta.appendChild(left);
      meta.appendChild(right);

      const textEl = document.createElement("div");
      textEl.className = "reflection-text";
      textEl.textContent = r.text;

      item.appendChild(meta);
      item.appendChild(textEl);
      reflectionListEl.appendChild(item);
    });
  }

  async function saveReflection() {
    reflectionErrorEl.textContent = "";
    const text = reflectionTextEl.value.trim();
    if (!text) {
      reflectionErrorEl.textContent = t("reflectionRequired");
      return;
    }
    if (!currentRoom || !currentParticipant) return;

    const mood = reflectionMoodEl.value || null;
    const energy = reflectionEnergyEl.value ? parseInt(reflectionEnergyEl.value, 10) : null;

    const { error } = await supabase
      .from("focus_reflections")
      .insert({
        room_id: currentRoom.id,
        participant_id: currentParticipant.id,
        text,
        mood,
        energy_level: energy
      });

    if (error) {
      reflectionErrorEl.textContent = error.message;
      return;
    }

    reflectionTextEl.value = "";
    reflectionMoodEl.value = "";
    reflectionEnergyEl.value = "";
    reflectionErrorEl.textContent = t("reflectionSaved");
    await loadReflections();
  }

  // --- Join / create room ---
  async function createRoom() {
    createErrorEl.textContent = "";
    const name = creatorNameInput.value.trim();
    const topic = topicInput.value.trim();
    const focusMin = parseInt(focusMinutesSelect.value, 10) || 25;
    const breakMin = parseInt(breakMinutesSelect.value, 10) || 5;

    if (!name) {
      createErrorEl.textContent = t("errorNameRequired");
      return;
    }
    if (!topic) {
      createErrorEl.textContent = t("errorTopicRequired");
      return;
    }

    await ensureMyStats(name);

    const slug = randomSlug();

    const { data: room, error } = await supabase
      .from("focus_rooms")
      .insert({
        slug,
        topic,
        host_name: name,
        focus_minutes: focusMin,
        break_minutes: breakMin
      })
      .select()
      .single();

    if (error) {
      createErrorEl.textContent = error.message;
      return;
    }

    const { data: participant, error: pErr } = await supabase
      .from("focus_participants")
      .insert({
        room_id: room.id,
        client_id: clientId,
        name,
        is_host: true,
        current_status: "joined"
      })
      .select()
      .single();

    if (pErr) {
      createErrorEl.textContent = pErr.message;
      return;
    }

    enterRoom(room, participant);
  }

  async function joinRoom() {
    joinErrorEl.textContent = "";
    const name = joinNameInput.value.trim();
    const code = joinCodeInput.value.trim().toUpperCase();

    if (!name) {
      joinErrorEl.textContent = t("errorNameRequired");
      return;
    }
    if (!code) {
      joinErrorEl.textContent = t("errorCodeRequired");
      return;
    }

    const room = await fetchRoomBySlug(code);
    if (!room) {
      joinErrorEl.textContent = t("errorRoomNotFound");
      return;
    }

    await ensureMyStats(name);

    const { data: participant, error } = await supabase
      .from("focus_participants")
      .insert({
        room_id: room.id,
        client_id: clientId,
        name,
        is_host: false,
        current_status: "joined"
      })
      .select()
      .single();

    if (error) {
      joinErrorEl.textContent = error.message;
      return;
    }

    enterRoom(room, participant);
  }

  function enterRoom(room, participant) {
    currentRoom = room;
    currentParticipant = participant;
    isHost = !!participant.is_host;
    setupSection.style.display = "none";
    roomSection.style.display = "block";
    saveLocalState();
    updateRoomUI();
    updateTimerUI();
    attachRealtime(room.id);
    fetchParticipants(room.id);
    fetchMyStats();
    loadReflections();
  }

  async function bootstrapIdentity() {
    const name = await ensureDisplayName();
    await ensureProfileRow(name);
    await loadProfileData();
    renderAvatar();
  }

  function attachRealtime(roomId) {
    supabase
      .channel("focus-room-" + roomId)
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "focus_rooms", filter: `id=eq.${roomId}` },
        payload => {
          if (payload.new) {
            currentRoom = payload.new;
            updateRoomUI();
            updateTimerUI();
          }
        }
      )
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "focus_participants", filter: `room_id=eq.${roomId}` },
        () => {
          fetchParticipants(roomId);
        }
      )
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "focus_reflections", filter: `room_id=eq.${roomId}` },
        () => {
          loadReflections();
        }
      )
      .subscribe();

    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateTimerUI, 1000);
  }

  async function autoRejoin() {
    // URL param
    const params = new URLSearchParams(window.location.search);
    const fromUrl = params.get("room");
    if (fromUrl) {
      joinCodeInput.value = fromUrl.toUpperCase();
    }

    let saved = null;
    try {
      saved = JSON.parse(localStorage.getItem(LS_STATE) || "null");
    } catch (_) {
      saved = null;
    }
    if (!saved || !saved.roomSlug || !saved.participantId || saved.clientId !== clientId) {
      return;
    }

    const room = await fetchRoomBySlug(saved.roomSlug);
    if (!room) {
      clearLocalState();
      return;
    }
    const participant = await fetchParticipantById(saved.participantId);
    if (!participant) {
      clearLocalState();
      return;
    }

    enterRoom(room, participant);
  }

  // --- Events ---
  createRoomBtn.addEventListener("click", createRoom);
  joinRoomBtn.addEventListener("click", joinRoom);
  saveReflectionBtn.addEventListener("click", saveReflection);

  avatarChip.addEventListener("click", openAvatarModal);
  avatarCancelBtn.addEventListener("click", closeAvatarModal);
  avatarSaveBtn.addEventListener("click", saveAvatarSelection);

  // Lang switch
  document.querySelectorAll(".lang-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const lang = btn.dataset.lang;
      if (!lang || lang === currentLang) return;
      currentLang = lang;
      document.querySelectorAll(".lang-btn").forEach(b =>
        b.classList.toggle("active", b.dataset.lang === currentLang)
      );
      applyLanguage();
    });
  });

  // --- init ---
  async function init() {
    ensureClientId();
    applyLanguage();
    await bootstrapIdentity();
    autoRejoin();
  }

  init();
</script>
</body>
</html>
